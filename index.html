<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CFI AI Center - Internal</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#1d9ec9",
              "primary-dark": "#157a9c",
              "primary-hover": "#1587ad",
              "background-light": "#f9fafb",
              "background-dark": "#16181d",
              "surface-dark": "#1c2426",
              "surface-darker": "#111617",
              "panel-dark": "#1e2329",
              "border-dark": "#293438",
              "text-secondary": "#9eb1b7",
              "success": "#6DBE31",
              "error": "#DB3E4E",
            },
            fontFamily: {
              "display": ["Manrope", "sans-serif"],
              "mono": ["JetBrains Mono", "monospace"],
            },
            boxShadow: {
                "glow": "0 0 15px rgba(29, 158, 201, 0.15)",
                "glow-sm": "0 0 8px rgba(29, 158, 201, 0.3)",
            },
            animation: {
                "fade-in-up": "fadeInUp 0.5s ease-out forwards",
            },
            keyframes: {
                fadeInUp: {
                    "0%": { opacity: "0", transform: "translateY(10px)" },
                    "100%": { opacity: "1", transform: "translateY(0)" },
                }
            }
          },
        },
      }
    </script>
    <style>
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
          width: 8px;
          height: 8px;
      }
      ::-webkit-scrollbar-track {
          background: #111617; 
      }
      ::-webkit-scrollbar-thumb {
          background: #293438; 
          border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
          background: #3d4d52; 
      }
      
      .toggle-checkbox:checked {
          right: 0;
          border-color: #1d9ec9;
      }
      .toggle-checkbox:checked + .toggle-label {
          background-color: #1d9ec9;
      }

      /* Loading Screen Styles */
      #app-loader {
        position: fixed;
        inset: 0;
        background-color: #16181d;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
      }
      .loader-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(29, 158, 201, 0.3);
        border-radius: 50%;
        border-top-color: #1d9ec9;
        animation: spin 1s ease-in-out infinite;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>

    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
  <body class="bg-background-dark text-white font-display overflow-hidden selection:bg-primary/30">
    
    <!-- Initial Loading Screen -->
    <div id="app-loader">
      <div class="loader-spinner mb-4"></div>
      <div class="text-[#9eb1b7] text-sm font-mono animate-pulse">Initializing Secure Runtime...</div>
      <div id="loader-status" class="text-[#58656a] text-xs mt-2 font-mono">Loading modules</div>
    </div>

    <div id="root"></div>

    <!-- 
      CUSTOM MODULE LOADER v2
      This script solves the "Invalid relative url" issue by pre-processing imports.
      It converts relative paths (e.g., './components/Sidebar') into absolute Module IDs 
      (e.g., 'components/Sidebar') mapped in the importmap.
    -->
    <script>
      (async function() {
        const updateStatus = (msg) => {
          const el = document.getElementById('loader-status');
          if(el) el.innerText = msg;
          console.log(`[Loader] ${msg}`);
        };

        // 1. Define Module IDs -> File Paths
        const modules = {
          'types': './types.ts',
          'components/Sidebar': './components/Sidebar.tsx',
          'components/ChatView': './components/ChatView.tsx',
          'components/ManagementView': './components/ManagementView.tsx',
          'components/SettingsView': './components/SettingsView.tsx',
          'App': './App.tsx',
          'index': './index.tsx'
        };

        const importMap = {
          imports: {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
          }
        };

        // Helper to rewrite imports in source code
        // e.g., import X from './components/Sidebar' -> import X from 'components/Sidebar'
        const rewriteImports = (sourceCode) => {
            return sourceCode.replace(/from\s+['"]([^'"]+)['"]/g, (match, path) => {
                // Ignore libraries (react, react-dom)
                if (!path.startsWith('.')) return match;
                
                // Simple heuristic resolvers for this project structure
                if (path.includes('Sidebar')) return `from 'components/Sidebar'`;
                if (path.includes('ChatView')) return `from 'components/ChatView'`;
                if (path.includes('ManagementView')) return `from 'components/ManagementView'`;
                if (path.includes('SettingsView')) return `from 'components/SettingsView'`;
                if (path.includes('types')) return `from 'types'`;
                if (path.includes('App')) return `from 'App'`;
                
                return match;
            });
        };

        try {
          updateStatus("Fetching source modules...");
          
          const promises = Object.entries(modules).map(async ([moduleId, url]) => {
            // Fetch
            const response = await fetch(url + '?t=' + Date.now());
            if (!response.ok) throw new Error(`Failed to load ${url}`);
            let rawCode = await response.text();

            // REWRITE IMPORTS BEFORE COMPILATION
            // This is the magic step that fixes "Invalid relative url"
            const processedCode = rewriteImports(rawCode);

            // Compile
            const result = Babel.transform(processedCode, {
              presets: ['react', 'typescript'],
              filename: url,
            });

            // Blob
            const blob = new Blob([result.code], { type: 'application/javascript' });
            const blobUrl = URL.createObjectURL(blob);

            // Register in Map
            importMap.imports[moduleId] = blobUrl;
          });

          await Promise.all(promises);

          updateStatus("Injecting Import Map...");
          
          const mapScript = document.createElement('script');
          mapScript.type = 'importmap';
          mapScript.textContent = JSON.stringify(importMap);
          document.head.appendChild(mapScript);

          updateStatus("Starting Application...");

          // Import Entry Point (using the ID 'index', not the file path)
          await import(importMap.imports['index']);

          setTimeout(() => {
            const loader = document.getElementById('app-loader');
            if(loader) {
              loader.style.opacity = '0';
              setTimeout(() => loader.remove(), 500);
            }
          }, 200);

        } catch (err) {
          console.error(err);
          updateStatus("Error: " + err.message);
          const statusEl = document.getElementById('loader-status');
          if(statusEl) statusEl.style.color = '#DB3E4E';
        }
      })();
    </script>
  </body>
</html>